{% extends "layout.html" %}

{% block title %}AI Chatbot - Learning Management System{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 700px;">
  <h2 class="mb-3 text-center">Chat với AI </h2>
  <div id="chat-box" class="mb-3 p-3 border rounded bg-light" style="height:400px;overflow-y:auto;font-size:1.1em;"></div>
  <div class="input-group">
    <input id="chat-input" type="text" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off">
    <button id="send-btn" class="btn btn-primary">Gửi</button>
  </div>
</div>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script>
const chatBox = document.getElementById('chat-box');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
let history = [];

function formatBotResponse(text) {
  // Xử lý code block markdown
  text = text.replace(/```python\n?([\s\S]*?)```/g, '<pre><code class="language-python">$1</code></pre>');
  text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
  // Xử lý xuống dòng ngoài code block
  // (chỉ thay \n thành <br> nếu không nằm trong <pre>...)</pre>
  // Đơn giản hóa: thay \n thành <br> (nếu muốn tối ưu hơn có thể dùng markdown-it)
  text = text.replace(/\n/g, '<br>');
  return text;
}

function appendMessage(sender, text) {
  const msg = document.createElement('div');
  if (sender === 'AI') {
    msg.className = 'text-start mb-2';
    msg.innerHTML = `<span class="badge bg-secondary">${sender}</span> <span class="ms-2">${formatBotResponse(text)}</span>`;
  } else {
    msg.className = 'text-end mb-2';
    msg.innerHTML = `<span class="badge bg-primary">${sender}</span> <span class="ms-2">${text}</span>`;
  }
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
  // Highlight code nếu có
  msg.querySelectorAll('pre code').forEach(block => { window.hljs && hljs.highlightElement(block); });
}

function renderHistory() {
  chatBox.innerHTML = '';
  for (const m of history) appendMessage(m.sender, m.text);
}

sendBtn.onclick = async function() {
  const message = chatInput.value.trim();
  if (!message) return;
  history.push({sender: 'Bạn', text: message});
  renderHistory();
  chatInput.value = '';
  history.push({sender: 'AI', text: '<i>Đang trả lời...</i>'});
  renderHistory();
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message})
    });
    const data = await res.json();
    history[history.length-1].text = data.response || data.error;
    renderHistory();
  } catch (e) {
    history[history.length-1].text = 'Lỗi kết nối server';
    renderHistory();
  }
};
chatInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') sendBtn.click();
});
</script>
{% endblock %} 