{% extends "layout.html" %}

{% block title %}Assignment Management - Learning Management System{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="page-header mb-4 text-center">
                <h1 class="page-title mb-2">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>Assignment Management
                </h1>
                <p class="page-subtitle">Create, manage, and grade student assignments</p>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end mb-4">
                <a href="{{ url_for('teacher_create_assignment') }}" class="btn btn-success me-2">
                    <i class="fas fa-plus mr-1"></i>Create Assignment
                </a>
                <a href="{{ url_for('create_sample_programming_assignment') }}" class="btn btn-info me-2">
                    <i class="fas fa-code mr-1"></i>Create Sample Programming Assignment
                </a>
                <a href="{{ url_for('create_sample_quiz') }}" class="btn btn-warning me-2">
                    <i class="fas fa-question-circle mr-1"></i>Create Sample Quiz
                </a>
                <a href="{{ url_for('teacher_create_quiz') }}" class="btn btn-primary me-2">
                    <i class="fas fa-plus mr-1"></i>Create Quiz
                </a>
                <button class="btn btn-outline-primary" onclick="refreshPage()">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
            </div>

            <!-- Assignment Statistics -->
            <div class="row g-3 mb-4 text-center">
                <div class="col-6 col-md-3">
                    <div class="stat-card stat-active mx-auto">
                        <div class="stat-icon"><i class="fas fa-play-circle"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ active_assignments or 0 }}</div>
                            <div class="stat-label">Active</div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card stat-pending mx-auto">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ pending_grades or 0 }}</div>
                            <div class="stat-label">Pending Grades</div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card stat-submissions mx-auto">
                        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ total_submissions or 0 }}</div>
                            <div class="stat-label">Total Submissions</div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card stat-courses mx-auto">
                        <div class="stat-icon"><i class="fas fa-book"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ total_courses or 0 }}</div>
                            <div class="stat-label">Courses</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('teacher_assignments') }}" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="course_filter" class="form-label">Course</label>
                            <select class="form-select" id="course_filter" name="course_id">
                                <option value="">All Courses</option>
                                {% for course in courses or [] %}
                                    <option value="{{ course.id }}" {% if request.args.get('course_id')|int == course.id %}selected{% endif %}>{{ course.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="type_filter" class="form-label">Type</label>
                            <select class="form-select" id="type_filter" name="type">
                                <option value="">All Types</option>
                                <option value="code" {% if request.args.get('type') == 'code' %}selected{% endif %}>Code</option>
                                <option value="quiz" {% if request.args.get('type') == 'quiz' %}selected{% endif %}>Quiz</option>
                                <option value="file" {% if request.args.get('type') == 'file' %}selected{% endif %}>File Upload</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status_filter" class="form-label">Status</label>
                            <select class="form-select" id="status_filter" name="status">
                                <option value="">All Status</option>
                                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" placeholder="Search assignments..." value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search mr-1"></i>Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Assignments Grid -->
            {% if assignments %}
                <div class="row g-4 justify-content-center">
                    {% for assignment in assignments %}
                    <div class="col-lg-4 col-md-6">
                        <div class="assignment-card h-100 mx-auto">
                            <div class="assignment-header">
                                <div class="assignment-type-badge">
                                    <i class="fas fa-{{ 'code' if assignment.type == 'code' else 'question-circle' if assignment.type == 'quiz' else 'file-upload' }}"></i>
                                    {{ assignment.type|title }}
                                </div>
                                <div class="assignment-status {{ 'active' if assignment.is_active else 'inactive' }}">
                                    <i class="fas fa-{{ 'check-circle' if assignment.is_active else 'times-circle' }}"></i>
                                    {{ 'Active' if assignment.is_active else 'Inactive' }}
                                </div>
                            </div>
                            
                            <div class="assignment-content">
                                <h5 class="assignment-title">{{ assignment.title }}</h5>
                                <p class="assignment-course">{{ assignment.course.name if assignment.course else 'Unknown Course' }}</p>
                                <p class="assignment-description">{{ assignment.description|truncate(100) if assignment.description else 'No description available.' }}</p>
                                
                                <div class="assignment-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Due: {{ assignment.due_date.strftime('%b %d, %Y at %I:%M %p') if assignment.due_date else 'No due date' }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-star"></i>
                                        <span>{{ assignment.max_score or 0 }} points</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-users"></i>
                                        <span>{{ assignment.submissions|length if assignment.submissions else 0 }} submissions</span>
                                    </div>
                                </div>
                                
                                <!-- Progress Bar -->
                                {% set submission_rate = ((assignment.submissions|length if assignment.submissions else 0) / (assignment.course.students|length if assignment.course and assignment.course.students else 1) * 100)|round(1) if assignment.course and assignment.course.students else 0 %}
                                <div class="submission-progress">
                                    <div class="progress-info">
                                        <span>Submission Rate</span>
                                        <span>{{ submission_rate }}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-rate-{{ assignment.id }}" style="width: {{ submission_rate }}%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Grading Status -->
                                {% if assignment.submissions %}
                                {% set graded_count = assignment.submissions|selectattr('score', 'defined')|list|length %}
                                {% set total_submissions = assignment.submissions|length %}
                                {% set grade = (graded_count / total_submissions * 100)|round(1) if total_submissions else 0 %}
                                <div class="grading-status">
                                    <div class="grading-info">
                                        <span>Grading Progress</span>
                                        <span>{{ graded_count }}/{{ total_submissions }}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success progress-bar-grade-{{ assignment.id }}"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="assignment-actions">
                                <div class="btn-group w-100" role="group">
                                    <a href="{{ url_for('assignments.view_assignment', assignment_id=assignment.id) }}" 
                                       class="btn btn-outline-primary" title="View Assignment">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('assignments.grade_submissions', assignment_id=assignment.id) }}" 
                                       class="btn btn-outline-success" title="Grade Submissions">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    <button class="btn btn-outline-warning" 
                                            onclick="editAssignment('{{ assignment.id }}')" title="Edit Assignment">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteAssignment('{{ assignment.id }}')" title="Delete Assignment">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state text-center my-5">
                    <div class="empty-icon mb-3">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <h3>No Assignments Yet</h3>
                    <p>Start creating assignments for your students to help them learn and grow!</p>
                    <a href="{{ url_for('teacher_create_assignment') }}" class="btn btn-primary btn-lg mt-3">
                        <i class="fas fa-plus mr-2"></i>Create Your First Assignment
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.page-header {
    padding: 2rem 0 1rem 0;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 2rem;
}
.page-title {
    color: #333;
    font-weight: 600;
    margin-bottom: 0.5rem;
}
.page-subtitle {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 0;
}
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.2rem 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 120px;
    max-width: 180px;
    margin-bottom: 1rem;
}
.stat-icon {
    font-size: 2rem;
    margin-right: 1rem;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
.stat-active .stat-icon { background: linear-gradient(135deg, #28a745, #20c997); }
.stat-pending .stat-icon { background: linear-gradient(135deg, #ffc107, #ff9800); }
.stat-submissions .stat-icon { background: linear-gradient(135deg, #17a2b8, #20c997); }
.stat-courses .stat-icon { background: linear-gradient(135deg, #6f42c1, #e83e8c); }
.stat-number { font-size: 1.5rem; font-weight: 700; color: #333; line-height: 1; }
.stat-label { font-size: 0.9rem; color: #666; margin-top: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px; }
.assignment-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; height: 100%; display: flex; flex-direction: column; max-width: 420px; }
.assignment-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
.empty-state { text-align: center; padding: 4rem 2rem; color: #666; }
.empty-icon { font-size: 4rem; color: #ddd; margin-bottom: 1.5rem; }
.empty-state h3 { color: #333; margin-bottom: 1rem; }
.empty-state p { font-size: 1.1rem; max-width: 400px; margin: 0 auto 2rem; }
@media (max-width: 768px) {
    .stat-card { min-width: 100px; max-width: 100%; }
    .assignment-card { max-width: 100%; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function refreshPage() {
    location.reload();
}

function toggleTypeFields() {
    const type = document.getElementById('type').value;
    document.getElementById('codeFields').style.display = type === 'code' ? 'block' : 'none';
    document.getElementById('fileFields').style.display = type === 'file' ? 'block' : 'none';
}

function editAssignment(id) {
    // TODO: Load assignment data and show edit modal
    alert('Edit functionality for assignment #' + id + ' will be implemented here.');
}

function deleteAssignment(id) {
    if (confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
        fetch(`/assignments/${id}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting assignment. Please try again.');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error deleting assignment. Please try again.');
        });
    }
}

// Auto-refresh every 10 minutes
setInterval(function() {
    if (window.location.pathname === '/teacher/assignments') {
        refreshPage();
    }
}, 600000); // 10 minutes

// Initialize datetime-local with current time + 1 week
document.addEventListener('DOMContentLoaded', function() {
    const dueDateInput = document.getElementById('due_date');
    if (dueDateInput) {
        const now = new Date();
        now.setDate(now.getDate() + 7); // 1 week from now
        dueDateInput.value = now.toISOString().slice(0, 16);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    var bar = document.querySelectorAll('[class^="progress-bar-grade-"]');
    {% for assignment in assignments %}
        var bar = document.querySelector('.progress-bar-grade-{{ assignment.id }}');
        if(bar) bar.style.width = '{{ grade }}%';
    {% endfor %}
});
</script>
{% endblock %} 